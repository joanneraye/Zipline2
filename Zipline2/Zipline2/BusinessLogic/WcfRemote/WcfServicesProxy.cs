using System;
using System.Collections.Generic;
using System.Text;
using System.ServiceModel;
using System.Threading.Tasks;
using Zipline2.Connected_Services;
using Zipline2.Models;
using Staunch.POS.Classes;

namespace Zipline2.BusinessLogic.WcfRemote
{
    
    public class WcfServicesProxy
    {

        private int counter = 0;



        #region Singleton
        private static WcfServicesProxy instance = null;
        private static readonly object padlock = new object();
      
        public static WcfServicesProxy Instance
        {
            get
            {
                lock (padlock)
                {
                    if (instance == null)
                    {
                        instance = new WcfServicesProxy();
                    }
                    return instance;
                }
            }
        }

        
        #endregion

        //The current Windows Phone app has a Service Reference folder with references
        //to the services.  When the services are added, the classes with references
        //are autogenerated. Then the phone app just has the following:

        private PosServiceClient waiterClient;
        private CheckHostClient checkClient;
        
        //public Dictionary<decimal, DBItem> MenuItemsPizza { get; private set; }
        //public Dictionary<decimal, DBItem> MenuItemsCalzone { get; private set; }
        //public Dictionary<decimal, DBItem> MenuItemsSalads { get; private set; }
        //public Dictionary<decimal, DBItem> MenuItemsBeverages { get; private set; }
        //public Dictionary<decimal, DBItem> MenuItemsDessert { get; private set; }
        private decimal UserIdDecimal;

        private WcfServicesProxy()
        {
            if (Users.Instance.LoggedInUser != null)
            {
                UserIdDecimal = Users.Instance.LoggedInUser.UserId;
            }
          
            try
            {
                waiterClient = new PosServiceClient(
                     new BasicHttpBinding(),
                     new EndpointAddress("http://192.168.1.26/WP7Waiter/POServiceHost.svc"));

                checkClient = new CheckHostClient(
                     new BasicHttpBinding(),
                     new EndpointAddress("http://192.168.1.26/CheckHost/CheckHost.svc"));
            }

            catch (Exception ex)
            {
                var errorMessage = ex;
                throw;
            }
        }

        public void UpdateTableSync(DBTable currentTable)
        {
            DBTable[] tablesToUpdate = new DBTable[] { currentTable };
            waiterClient.UpdateTables(tablesToUpdate, (decimal)Users.Instance.LoggedInUser.UserId);
        }

        async public Task UpdateTableAsync(DBTable currentTable)
        {

            DBTable[] tablesToUpdate = new DBTable[] { currentTable };
            await Task.Factory.FromAsync(
                waiterClient.BeginUpdateTables,
                waiterClient.EndUpdateTables,
                tablesToUpdate,
                (decimal)Users.Instance.LoggedInUser.UserId,
                TaskCreationOptions.None);
        }

        public DBTable GetTableSync(int tableNum)
        {
            try
            {
                return waiterClient.GetTable(tableNum);
            }
            catch (Exception e)
            {
             waiterClient.GetTablesForSection(1);   Exception error = e;
                throw;
            }
        }

        public void GetTablesSync()
        {
            DataBaseDictionaries.DbTablesDictionary = new Dictionary<decimal, DBTable>();
            DBTable[] tablesSection1 = waiterClient.GetTablesForSection(1);
            foreach (var item1 in tablesSection1)
            {
                item1.Guests = new List<Staunch.POS.Classes.Guest_DB>();
                DataBaseDictionaries.DbTablesDictionary.Add(item1.ID, item1);
            }
            DBTable[] tablesSection2 = waiterClient.GetTablesForSection(2);
            foreach (var item2 in tablesSection2)
            {
                item2.Guests = new List<Staunch.POS.Classes.Guest_DB>();
                DataBaseDictionaries.DbTablesDictionary.Add(item2.ID, item2);
            }
        }

        async public Task<DBTable> GetTableAsync(int tableNum)
        {
                return await Task.Factory.FromAsync(
                    waiterClient.BeginGetTable,
                    waiterClient.EndGetTable,
                    tableNum,
                    TaskCreationOptions.None);
        }

        async public Task<DBModGroup[]> GetToppingsAsync()
        {
           return await Task.Factory.FromAsync(
                waiterClient.BeginGetAllMods,
                waiterClient.EndGetAllMods,
                (decimal)57,
                (decimal)12,
                TaskCreationOptions.None);

        }

        public void GetMenuSync()
        {
            try
            {
                DataBaseDictionaries.MenuDictionary = waiterClient.GetMenu();
            }
            catch (Exception ex)
            {
                var errormessage = ex;
                throw;
            }
        }

        async public Task GetMenuAsync()
        {
            DataBaseDictionaries.MenuDictionary = new Dictionary<string, DBItem[]>();
            try
            {
                DataBaseDictionaries.MenuDictionary = await Task.Factory.FromAsync(
                    waiterClient.BeginGetMenu,
                    waiterClient.EndGetMenu,
                    null,
                    TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var errormessage = ex;
                throw;
            }
        }

        async public Task<decimal> GetNextGuestIdAsync()
        {
            decimal[] ids = await Task.Factory.FromAsync(
                waiterClient.BeginGetNextGuestIDs,
                waiterClient.EndGetNextGuestIDs,
                1,
                UserIdDecimal,
                TaskCreationOptions.None);
            if (ids.Length > 0)
            {
                return ids[0];
            }
            return 0;
        }

        public decimal GetNextGuestIdSync()
        {
            decimal[] ids = waiterClient.GetNextGuestIDs(1, UserIdDecimal);
            if (ids.Length > 0)
            {
                return ids[0];
            }
            return 0;
        }

        public void UpdateOrderSync(Order orderToUpdate)
        {
            counter = counter + 1;
           
            DBTable dbTableCurrent = ConvertOrderToDbTable(orderToUpdate, false);

            //Update the database table with built DBTable in order to obtain new OrderID.
            //await UpdateTableAsync(dbTableCurrent);
            UpdateTableSync(dbTableCurrent);
        }

        internal DBTable ConvertOrderToDbTable(Order orderToSend, bool sendOrderToKitchen = false)
        {
            decimal[] guestIds = GetGuestIdsSync(orderToSend.TableId);
            //decimal guestId = await GetGuestIdAsync(orderToUpdate.TableId);

            //Get stored DBTable.
            DBTable newTable = DataBaseDictionaries.DbTablesDictionary[orderToSend.TableId];

            //Create Guest_DBs for table Guests.
            bool first = true;
            foreach (decimal id in guestIds)
            {
                Staunch.POS.Classes.Guest_DB guest = new Staunch.POS.Classes.Guest_DB();
                guest.ID = id;
                guest.CheckedOut = false;
                guest.Items = new List<GuestItem>();
                guest.ComboItems = new List<GuestComboItem>();
                guest.TableID = orderToSend.TableId;

                if (first)
                {
                    guest.IsWhole = true;
                    first = false;
                }

                newTable.Guests.Add(guest);
            }

            if (DataBaseDictionaries.MenuDictionary != null &&
                DataBaseDictionaries.MenuDictionary.Count > 0)
            {
                //Create DBItems for Guest_DB object.
                foreach (var orderItem in orderToSend.OrderItems)
                {
                    var keysTuple = orderItem.GetMenuDbItemKeys();
                    var dbItem = new DBItem();
                    bool menuItemFound = false;

                    //Use the item from the Database Dictionary.                    
                    foreach (var menuItem in DataBaseDictionaries.MenuDictionary[keysTuple.Item1])
                    {
                        if (menuItem.ID == keysTuple.Item2)
                        {
                            dbItem = menuItem;
                            menuItemFound = true;
                            break;
                        }
                    }
                    if (orderItem.DbOrderId <= 0)
                    {
                        orderItem.DbOrderId = -1;
                    }
                    if (menuItemFound)
                    {
                        GuestItem guestItem = orderItem.CreateGuestItem(dbItem, orderItem.DbOrderId);
                        guestItem.Mods = orderItem.CreateMods();
                        guestItem.OrderSent = sendOrderToKitchen;
                        newTable.Guests[0].Items.Add(guestItem);
                    }
                }
            }
            return newTable;
        }


        async public void UpdateOrderAsync(Order orderToUpdate)
        {
            counter = counter + 1;
            //decimal guestId = await GetGuestIdAsync(orderToUpdate.TableId);
            DBTable dbTableCurrent = ConvertOrderToDbTable(orderToUpdate, false);

            //Update the database table with built DBTable in order to obtain new OrderID.
            //await UpdateTableAsync(dbTableCurrent);
            await UpdateTableAsync(dbTableCurrent);
        }

        private decimal[] GetGuestIdsSync(decimal tableId)
        {
            DBTable thisTable = GetTableSync((int)tableId);
            decimal[] guestIds = new decimal[2];
            if (thisTable.Guests.Count > 1)
            {
                guestIds[0] = (thisTable.Guests[0].ID);
                guestIds[1] = (thisTable.Guests[1].ID);
            }
            else
            {
                guestIds = waiterClient.GetNextGuestIDs((2), UserIdDecimal);
            }
            return guestIds;
        }

        async private Task<decimal[]> GetGuestIdsAsync(decimal tableId)
        {
            DBTable thisTable = await GetTableAsync((int)tableId);
            decimal[] guestIds = new decimal[2];
            if (thisTable.Guests.Count > 1)
            {
                guestIds[0] = (thisTable.Guests[0].ID);
                guestIds[1] = (thisTable.Guests[1].ID);
            }
            else
            {
                guestIds = waiterClient.GetNextGuestIDs((2), UserIdDecimal);
            }
            return guestIds;

        }

        async public void SendOrderSync(Order orderToSend)
        {
            DBTable dbTableCurrent = ConvertOrderToDbTable(orderToSend, true);

            //Update the database table with built DBTable in order to obtain new OrderID.
            //await UpdateTableAsync(dbTableCurrent);
            UpdateTableSync(dbTableCurrent);

            //Get the table just updated - will contain new OrderID.
            DBTable updatedTable = GetTableSync((int)dbTableCurrent.ID);

            //Get the GuestItem obejcts from the DBTable object needed for the DBCheck.
            List<GuestItem> items = updatedTable.Guests[0].Items;
            DBCheck dbCheck = new DBCheck()
            {
                ID = orderToSend.TableId,
                ComboItems = new List<GuestComboItem>(),
                Discounts = new List<OrderDiscount>(),
                GuestIDs = new List<decimal>(),
                Name = string.Empty,
                Notes = new DBNotes(),
                Items = items
            };

            //Creates and adds check to database.
            await CreateCheckAsync(dbCheck);
        }

        async public void SendOrderAsync(Order orderToSend)
        {
           
            DBTable dbTableCurrent = ConvertOrderToDbTable(orderToSend, true);

            //Update the database table with built DBTable in order to obtain new OrderID.
            //await UpdateTableAsync(dbTableCurrent);
            UpdateTableSync(dbTableCurrent);

            //Get the table just updated - will contain new OrderID.
            DBTable updatedTable = await GetTableAsync((int)dbTableCurrent.ID);

            //Get the GuestItem obejcts from the DBTable object needed for the DBCheck.
            List<GuestItem> items = updatedTable.Guests[0].Items;
            DBCheck dbCheck = new DBCheck()
            {
                ID = orderToSend.TableId,
                ComboItems = new List<GuestComboItem>(),
                Discounts = new List<OrderDiscount>(),
                GuestIDs = new List<decimal>(),
                Name = string.Empty,
                Notes = new DBNotes(),
                Items = items
            };

            //Creates and adds check to database.
            await CreateCheckAsync(dbCheck);
        }

        public DBUser GetUserSync(string pin)
        {
            DBUser thisUser =  waiterClient.GetUser(pin);
            return thisUser;
        }

        //async public Task<DBUser> GetUserAsync(string pin)
        //{
        //    return await Task.Factory.FromAsync(
        //            waiterClient.BeginGetUser,
        //            waiterClient.EndGetUser,
        //            pin,
        //            TaskCreationOptions.None);
        //}

        async public Task<DBTable[]> GetTablesForSectionAsync(decimal sectionID)
        {
            return await Task.Factory.FromAsync(
                waiterClient.BeginGetTablesForSection,
                waiterClient.EndGetTablesForSection,
                sectionID,
                TaskCreationOptions.None);
        }

        async public Task<bool> HasOpenChecksAsync(decimal tableId)
        {
            return await Task.Factory.FromAsync(
                checkClient.BeginHasOpenChecks,
                checkClient.EndHasOpenChecks,
                tableId,
                TaskCreationOptions.None);

        }

        async public Task<DBCheck[]> GetOpenChecksAsync(decimal tableId)
        {
            return await Task.Factory.FromAsync(
                checkClient.BeginGetOpenChecks,
                checkClient.EndGetOpenChecks,
                tableId,
                TaskCreationOptions.None);
        }




        async public Task CreateCheckAsync(DBCheck dbCheck)
        {
            var dbChecks = new DBCheck[]
            {
                dbCheck
            };
            try
            {
                var result = await Task.Factory.FromAsync(
                    checkClient.BeginCreateChecks,
                    checkClient.EndCreateChecks,
                    dbChecks,UserIdDecimal, false,
                    TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var errormessage = ex;
                throw;
            }
        }
    }
}
